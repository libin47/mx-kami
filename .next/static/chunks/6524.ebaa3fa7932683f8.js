"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6524],{56524:function(d,b,a){a.r(b),a.d(b,{socketClient:function(){return y}});var e=a(67697),f=a(9378),g=a(86009),h=a(55812),i=a(43025),j=a(19360),k=a(39137),l=a(32872),m=a(51113),n=a(38325),o=a(12464),p=a(23116),q=function(){var c=document.body,b=document.getElementById("dangmaku");if(!b){var a=document.createElement("div");return a.setAttribute("id","dangmaku"),a.style.cssText="\n      position: fixed;\n      top: 4rem;\n      bottom: 50vh;\n      z-index: -1;\n      overflow: hidden;\n      left: 0;\n      right: 0;\n    ",c.appendChild(a),a}return b},r=function(a){var c=a.color,g=a.duration,e=a.text,d=q(),f=d.getBoundingClientRect().height,b=document.createElement("div");Object.assign(b.style,{color:null!=c?c:"",position:"absolute",fontSize:"16px",top:"".concat(14*(0,p.Z)((0,o.Z)(0,f>>8)),"px")}),Object.assign(b,{textContent:e,onanimationend:function(a){b.remove()}}),d.appendChild(b),requestAnimationFrame(function(){b.style.animation="dangmaku ".concat(g&&g/1e3>8?g:8,"s steps(30) ")})},c=a(53150);function s(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var t=c.q.shared,u=function(f,a){var c,d=(null===(A=window.data)|| void 0===A?void 0:A.aggregateData.seo.title)||"Kami",u=(null===(B=window.data)|| void 0===B?void 0:B.aggregateData.url.webUrl.replace(/\/$/,""))||(null==globalThis?void 0:globalThis.location.host)||"",x=n.h.gatewayStore,y=n.h.noteStore,g=n.h.postStore,b=n.h.userStore,h=n.h.pageStore;switch(f){case m.G.VISITOR_ONLINE:case m.G.VISITOR_OFFLINE:var z=a.online;(0,j.z)(function(){x.online=z});break;case m.G.RECENTLY_CREATE:t.notice({title:d,text:"\u7AD9\u957F\u53D1\u5E03\u4E00\u6761\u65B0\u52A8\u6001",description:a.content,onclick:function(){window.open("".concat(u,"/recently"))}});break;case m.G.POST_CREATE:case m.G.NOTE_CREATE:if(a.hide)break;var A,B,e,i=v("\u6587\u7AE0",a.title),C=(s(e={},m.G.POST_CREATE,"post"),s(e,m.G.NOTE_CREATE,"note"),e);t.notice({title:d,text:i,description:w(a.text),onclick:function(){window.open(u+("post"===C[f]?"/posts/".concat(a.category.slug,"/").concat(a.slug):"/notes/".concat(a.nid)))}});break;case m.G.SAY_CREATE:n.h.sayStore.add(a);var o=v("\u8BF4\u8BF4");t.notice({title:d,text:o,description:w(a.text),onclick:function(){window.open("".concat(u,"/says"))}});break;case m.G.SAY_DELETE:var p=a;n.h.sayStore.remove(p);break;case m.G.COMMENT_CREATE:n.h.commentStore.addComment(a);break;case m.G.DANMAKU_CREATE:r({text:"".concat(a.author,": ").concat(a.text),color:a.color}),a.author!=b.name&&a.author!=b.username||b.isLogged||t.notice({title:"".concat(b.name," \u6572\u4E86\u4F60\u4E00\u4E0B"),text:a.text,options:{image:null===(c=b.master)|| void 0===c?void 0:c.avatar}});break;case m.G.POST_UPDATE:g.addAndPatch(a);break;case m.G.POST_DELETE:var q=a;g.softDelete(q);break;case m.G.NOTE_UPDATE:(0,j.z)(function(){y.addAndPatch(a);var b=y.get(a.id);b&&b.hide&&!n.h.userStore.isLogged&&(b.title="\u5DF2\u9690\u85CF",b.text="\u8BE5\u7B14\u8BB0\u5DF2\u88AB\u9690\u85CF")});break;case m.G.NOTE_DELETE:var D=a;(0,j.z)(function(){y.softDelete(D);var a=y.get(D);a&&(a.title="\u5DF2\u5220\u9664",a.text="\u8BE5\u7B14\u8BB0\u5DF2\u88AB\u5220\u9664")});break;case m.G.PAGE_UPDATED:k.yw.info("\u9875\u9762\u5185\u5BB9\u5DF2\u66F4\u65B0"),h.addAndPatch(a);break;default:l.r8&&console.log(f,a)}};function v(b,a){return"".concat(n.h.userStore.name,"\u53D1\u5E03\u4E86\u65B0\u7684").concat(b).concat(a?": ".concat(a):"")}function w(a){return a.length>20?"".concat(a.slice(0,20),"..."):a}function x(d,c){for(var b=0;b<c.length;b++){var a=c[b];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(d,a.key,a)}}var y=new(function(){"use strict";var a,b,c;function d(){var a,b,c;!function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}(this,d),a=this,c=void 0,(b="socket")in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,this.socket=(0,e.io)("".concat(g.j,"/web"),{timeout:1e4,reconnectionDelay:3e3,autoConnect:!1,reconnectionAttempts:3,transports:["websocket"]})}return a=d,b=[{key:"initIO",value:function(){var a=this;this.socket&&(this.socket.close(),this.socket.open(),this.socket.on("message",function(b){if("string"!=typeof b)return a.handleEvent(b.type,(0,f.U)(b.data,{deep:!0}));var c=JSON.parse(b),d=c.data,e=c.type;a.handleEvent(e,(0,f.U)(d,{deep:!0}))}))}},{key:"reconnect",value:function(){this.socket.open()}},{key:"handleEvent",value:function(b,a){h.r8&&console.log(a),i.Y.emit(b,a),u(b,a)}},{key:"emit",value:function(a,b){var c=this;return new Promise(function(d){c.socket&&c.socket.connected&&c.socket.emit(a,b,function(a){d(a)})})}}],x(a.prototype,b),c&&x(a,c),d}())},51113:function(f,d,e){var b,c,g,a;e.d(d,{G:function(){return c},R:function(){return b}}),(b||(b={})).TOC="toc",(a=c||(c={})).GATEWAY_CONNECT="GATEWAY_CONNECT",a.GATEWAY_DISCONNECT="GATEWAY_DISCONNECT",a.VISITOR_ONLINE="VISITOR_ONLINE",a.VISITOR_OFFLINE="VISITOR_OFFLINE",a.AUTH_FAILED="AUTH_FAILED",a.COMMENT_CREATE="COMMENT_CREATE",a.POST_CREATE="POST_CREATE",a.POST_UPDATE="POST_UPDATE",a.POST_DELETE="POST_DELETE",a.NOTE_CREATE="NOTE_CREATE",a.NOTE_UPDATE="NOTE_UPDATE",a.NOTE_DELETE="NOTE_DELETE",a.PAGE_UPDATED="PAGE_UPDATED",a.SAY_CREATE="SAY_CREATE",a.SAY_DELETE="SAY_DELETE",a.SAY_UPDATE="SAY_UPDATE",a.DANMAKU_CREATE="DANMAKU_CREATE",a.RECENTLY_CREATE="RECENTLY_CREATE",a.RECENTLY_DElETE="RECENTLY_DElETE"}}])